<div class="container">
  <app-header
    title="Transactions"
    actionLabel="New Transaction"
    actionLink="/transactions/new"
  ></app-header>

  @if (loading()) {
    <div class="loading-spinner">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    @if (transactions().length > 0) {
      <mat-card class="table-card">
        <table mat-table [dataSource]="transactions()" class="transactions-table">
          <!-- Due Date Column -->
          <ng-container matColumnDef="due_date">
            <th mat-header-cell *matHeaderCellDef>Due Date</th>
            <td mat-cell *matCellDef="let transaction">
              {{ formatDate(transaction.due_date) }}
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let transaction">
              <mat-chip [class]="'type-chip-' + transaction.transaction_type">
                {{ transaction.transaction_type | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td
              mat-cell
              *matCellDef="let transaction"
              [class.positive]="transaction.transaction_type === 'credit'"
              [class.negative]="
                transaction.transaction_type === 'debit' ||
                transaction.transaction_type === 'payment'
              "
            >
              {{ formatCurrency(transaction.amount, transaction.currency) }}
            </td>
          </ng-container>

          <!-- Account Column -->
          <ng-container matColumnDef="from_account">
            <th mat-header-cell *matHeaderCellDef>Account</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="icon-column">
                @let account = getAccount(transaction.from_account_id);
                <app-icon
                  mat-card-avatar
                  class="icon"
                  [style.background-color]="
                    'color-mix(in srgb, ' + account.color + ', transparent 80%)'
                  "
                  [name]="account.icon || 'ðŸ’°'"
                  [color]="account.color"
                  [size]="32"
                ></app-icon>
                <span>{{ account.name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Category</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="icon-column">
                @let category = getCategory(transaction.category_id);
                <app-icon
                  mat-card-avatar
                  class="icon"
                  [style.background-color]="
                    'color-mix(in srgb, ' + category.color + ', transparent 80%)'
                  "
                  [name]="category.icon || 'ðŸ’°'"
                  [color]="category.color"
                  [size]="32"
                ></app-icon>
                <span>{{ category.name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Payment Status Column -->
          <ng-container matColumnDef="payment_status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let transaction">
              <mat-chip [class]="'status-chip-' + getPaymentStatus(transaction)">
                {{ getPaymentStatus(transaction) | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let transaction">
              <button
                mat-icon-button
                [routerLink]="['/transactions', transaction.id, 'edit']"
                matTooltip="Edit"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="deleteTransaction(transaction, $event)"
                matTooltip="Delete"
                color="warn"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [routerLink]="['/transactions', row.id]"
            class="clickable-row"
          ></tr>
        </table>
      </mat-card>
    } @else {
      <app-empty-state
        title="No transactions found"
        message="Create your first transaction to start tracking your finances."
        icon="receipt_long"
        actionLabel="New Transaction"
        actionLink="/transactions/new"
      ></app-empty-state>
    }
  }
</div>
