<div class="category-form-container">
  <div class="header">
    <h1>{{ isEditMode() ? 'Edit Category' : 'Create Category' }}</h1>
  </div>

  <mat-card>
    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <div class="type-selection">
            <span id="type-radio-group-label" class="form-label">Category Type</span>
            <mat-radio-group aria-labelledby="type-radio-group-label" formControlName="type">
              @for (option of typeOptions; track option.value) {
                <mat-radio-button [value]="option.value">{{ option.label }}</mat-radio-button>
              }
            </mat-radio-group>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Name</mat-label>
            <input matInput formControlName="name" placeholder="Category Name" />
            @if (form.get('name')?.hasError('required')) {
              <mat-error>Name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Parent Category</mat-label>
            <mat-select formControlName="parent_category_id">
              <mat-option [value]="null">-- None --</mat-option>
              @for (cat of categories(); track cat.id) {
                <!-- Prevent selecting self as parent -->
                @if (cat.id !== categoryId()) {
                  <mat-option [value]="cat.id">
                    {{ cat.name }}
                  </mat-option>
                }
              }
            </mat-select>
          </mat-form-field>

          <div class="icon-selection-container" role="radiogroup" aria-labelledby="icon-label">
            <span id="icon-label" class="form-label">Icon</span>
            <div class="icon-grid">
              @for (icon of icons; track icon.name) {
                <button
                  type="button"
                  class="icon-circle"
                  [class.selected]="form.controls.icon.value === icon.name"
                  [attr.aria-label]="'Select icon ' + icon.name"
                  [attr.aria-pressed]="form.controls.icon.value === icon.name"
                  (click)="selectIcon(icon)"
                >
                  <app-icon
                    class="icon-svg"
                    [name]="icon.name"
                    [color]="icon.defaultColor"
                    [size]="32"
                  ></app-icon>
                  @if (form.controls.icon.value === icon.name) {
                    <div class="selected-overlay">
                      <mat-icon class="check-icon">check</mat-icon>
                    </div>
                  }
                </button>
              }
            </div>
          </div>

          <div class="color-selection-container" role="radiogroup" aria-labelledby="color-label">
            <span id="color-label" class="form-label">Color</span>
            <div class="color-grid">
              @for (color of colorPalette; track color) {
                <button
                  type="button"
                  class="color-circle"
                  [style.background-color]="color"
                  [class.selected]="form.controls.color.value === color"
                  [attr.aria-label]="'Select color ' + color"
                  [attr.aria-pressed]="form.controls.color.value === color"
                  (click)="selectColor(color)"
                >
                  @if (form.controls.color.value === color) {
                    <mat-icon class="check-icon">check</mat-icon>
                  }
                </button>
              }
            </div>
            <!-- Hidden input to maintain form control binding if needed, or rely on patchValue -->
            <input type="hidden" formControlName="color" />
          </div>

          <input type="hidden" formControlName="icon" />
        </div>

        <div class="actions">
          <button mat-button type="button" routerLink="/categories">Cancel</button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="form.invalid || categoryService.loading()"
          >
            {{ isEditMode() ? 'Update' : 'Create' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
